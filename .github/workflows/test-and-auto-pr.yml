name: Tests + Coverage â†’ Auto PR

permissions:
  contents: write
  pull-requests: write

on:
  push:
    branches:
      - main
      - 'feature/**'
  workflow_dispatch:

env:
  COVERAGE_THRESHOLD: 80.0
  PR_AUTOMATION_ENABLED: true

jobs:
  build-and-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Run Maven (tests + verify)
        run: mvn -U clean verify

      - name: Generate jacoco report (fallback)
        run: mvn jacoco:report || true

      - name: Run coverage analyzer
        id: analyze
        run: |
          python3 .mcp/coverage_analyzer.py --json > coverage.json
          python3 - <<'PY'
          import json,sys,os
          j=json.load(open('coverage.json'))
          cov = j.get('coverage_pct')
          if cov is None:
              c = j.get('coverage') or {}
              if isinstance(c, dict):
                  line = c.get('line') or {}
                  instr = c.get('instruction') or {}
                  cov = line.get('percent') if isinstance(line, dict) else None
                  if cov is None:
                      cov = instr.get('percent') if isinstance(instr, dict) else None
          if cov is None:
              print('No coverage percent found in analyzer output')
              sys.exit(1)
          # export as job output
          with open(os.environ['GITHUB_OUTPUT'],'a') as fh:
              fh.write(f"coverage={cov}\n")
          print('coverage='+str(cov))
          PY

      - name: Check PR token availability
        id: pr_token_check
        run: |
          # Detect presence of repository secret indirectly: use an env var injected by workflow_dispatch or set manually.
          if [ -z "${PR_AUTOMATION_TOKEN}" ]; then
            echo "available=false" >> $GITHUB_OUTPUT
          else
            echo "available=true" >> $GITHUB_OUTPUT
          fi

      - name: Create branch + PR when coverage >= threshold (requires PR_AUTOMATION_TOKEN env)
        if: ${{ steps.analyze.outputs.coverage && (fromJson(steps.analyze.outputs.coverage) >= env.COVERAGE_THRESHOLD) && steps.pr_token_check.outputs.available == 'true' && env.PR_AUTOMATION_ENABLED == 'true' }}
        uses: peter-evans/create-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          token: ${{ env.GITHUB_TOKEN }}
          commit-message: 'chore: automated coverage PR - coverage ${{ steps.analyze.outputs.coverage }} - ${{ github.sha }}'
          title: 'Automated: coverage >= ${{ env.COVERAGE_THRESHOLD }}%'
          body: |
            CI detected coverage >= threshold.
            This PR was opened automatically by CI using PAT secret PR_AUTOMATION_TOKEN.
          branch: auto/coverage-${{ github.sha }}
          base: main

      - name: Skip PR (no token or disabled)
        if: ${{ steps.analyze.outputs.coverage && (fromJson(steps.analyze.outputs.coverage) >= env.COVERAGE_THRESHOLD) && (steps.pr_token_check.outputs.available != 'true' || env.PR_AUTOMATION_ENABLED != 'true') }}
        run: echo "Coverage threshold met but PR automation disabled or token missing. Create PR manually for branch auto/coverage-${{ github.sha }} if desired." 
